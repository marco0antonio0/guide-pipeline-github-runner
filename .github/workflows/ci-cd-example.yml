# Pipeline CI/CD - PadrÃµes Comuns de IntegraÃ§Ã£o e Entrega ContÃ­nua
# Este workflow demonstra prÃ¡ticas reais de CI/CD

name: CI/CD Completo

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# Definir permissÃµes mÃ­nimas
permissions:
  contents: read

jobs:
  # Job de Lint e VerificaÃ§Ã£o de CÃ³digo
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: Verificar sintaxe YAML
        run: |
          echo "ğŸ” Verificando arquivos YAML..."
          for file in $(find .github/workflows -name "*.yml" -o -name "*.yaml"); do
            echo "Verificando: $file"
            if command -v yamllint &> /dev/null; then
              yamllint "$file"
            else
              # VerificaÃ§Ã£o bÃ¡sica de sintaxe
              python3 -c "import yaml; yaml.safe_load(open('$file'))" && echo "âœ… $file OK"
            fi
          done
      
      - name: Verificar arquivos Markdown
        run: |
          echo "ğŸ“ Verificando arquivos Markdown..."
          if [ -f README.md ]; then
            echo "âœ… README.md encontrado"
            wc -l README.md
          fi

  # Job de Build com Matrix Strategy
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16, 18, 20]
      fail-fast: false
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Exibir versÃµes
        run: |
          echo "ğŸ“¦ Node.js: $(node --version)"
          echo "ğŸ“¦ npm: $(npm --version)"
      
      - name: Simular instalaÃ§Ã£o de dependÃªncias
        run: |
          echo "ğŸ“¥ Instalando dependÃªncias..."
          # Em um projeto real, seria: npm ci
          echo "âœ… DependÃªncias instaladas (simulado)"
      
      - name: Simular build
        run: |
          echo "ğŸ”¨ Executando build..."
          # Em um projeto real, seria: npm run build
          mkdir -p dist
          echo "console.log('Built with Node ${{ matrix.node-version }}');" > dist/index.js
          echo "âœ… Build concluÃ­do"
      
      - name: Upload do artifact
        uses: actions/upload-artifact@v3
        with:
          name: build-node-${{ matrix.node-version }}
          path: dist/
          retention-days: 1

  # Job de Testes
  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: Simular testes unitÃ¡rios
        run: |
          echo "ğŸ§ª Executando testes unitÃ¡rios..."
          # Em um projeto real, seria: npm test
          sleep 2
          echo "âœ… 10 testes passaram"
      
      - name: Simular testes de integraÃ§Ã£o
        run: |
          echo "ğŸ”— Executando testes de integraÃ§Ã£o..."
          # Em um projeto real, seria: npm run test:integration
          sleep 2
          echo "âœ… 5 testes de integraÃ§Ã£o passaram"
      
      - name: Gerar relatÃ³rio de cobertura
        run: |
          echo "ğŸ“Š Gerando relatÃ³rio de cobertura..."
          mkdir -p coverage
          echo "Cobertura: 85%" > coverage/report.txt
          cat coverage/report.txt
      
      - name: Upload do relatÃ³rio de cobertura
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # Job de AnÃ¡lise de SeguranÃ§a
  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: Verificar vulnerabilidades
        run: |
          echo "ğŸ”’ Verificando vulnerabilidades..."
          # Em um projeto real, seria: npm audit
          echo "âœ… Nenhuma vulnerabilidade crÃ­tica encontrada"
      
      - name: Verificar secrets expostos
        run: |
          echo "ğŸ” Verificando secrets expostos no cÃ³digo..."
          # VerificaÃ§Ã£o simples de padrÃµes comuns
          if grep -r "password\s*=\s*['\"]" . --exclude-dir=.git 2>/dev/null; then
            echo "âš ï¸ PossÃ­veis senhas encontradas no cÃ³digo"
          else
            echo "âœ… Nenhum secret exposto detectado"
          fi

  # Job de Deploy (Staging)
  deploy-staging:
    runs-on: ubuntu-latest
    needs: [build, test, security]
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.exemplo.com
    steps:
      - name: Download do artifact
        uses: actions/download-artifact@v3
        with:
          name: build-node-20
      
      - name: Simular deploy para staging
        run: |
          echo "ğŸš€ Fazendo deploy para staging..."
          echo "ğŸ“¦ Arquivos para deploy:"
          ls -la
          # Em um projeto real, seria: scp, rsync, ou deploy para cloud
          sleep 2
          echo "âœ… Deploy para staging concluÃ­do!"
      
      - name: Verificar health check
        run: |
          echo "ğŸ¥ Verificando saÃºde da aplicaÃ§Ã£o..."
          # Em um projeto real, seria: curl https://staging.exemplo.com/health
          echo "âœ… AplicaÃ§Ã£o estÃ¡ saudÃ¡vel"

  # Job de Deploy (Production)
  deploy-production:
    runs-on: ubuntu-latest
    needs: [build, test, security]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment:
      name: production
      url: https://exemplo.com
    steps:
      - name: Download do artifact
        uses: actions/download-artifact@v3
        with:
          name: build-node-20
      
      - name: Simular deploy para produÃ§Ã£o
        run: |
          echo "ğŸš€ Fazendo deploy para produÃ§Ã£o..."
          echo "ğŸ“¦ Arquivos para deploy:"
          ls -la
          # Em um projeto real, seria deploy para servidor de produÃ§Ã£o
          sleep 2
          echo "âœ… Deploy para produÃ§Ã£o concluÃ­do!"
      
      - name: Notificar sucesso
        run: |
          echo "ğŸ“¢ Deploy concluÃ­do com sucesso!"
          echo "ğŸ”— URL: https://exemplo.com"

  # Job de Cache
  cache-example:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Cache de dependÃªncias
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Demonstrar uso do cache
        run: |
          echo "ğŸ’¾ Cache de dependÃªncias configurado"
          echo "âœ… Nas prÃ³ximas execuÃ§Ãµes, as dependÃªncias serÃ£o restauradas do cache"

  # Job de NotificaÃ§Ã£o Final
  notify:
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    if: always()
    steps:
      - name: Verificar status do workflow
        run: |
          echo "ğŸ“Š === RESUMO DO WORKFLOW ==="
          echo "Status do Lint: ${{ needs.lint.result }}"
          echo "Status dos Testes: ${{ needs.test.result }}"
          echo "Status de SeguranÃ§a: ${{ needs.security.result }}"
          
          if [ "${{ needs.lint.result }}" = "success" ] && \
             [ "${{ needs.test.result }}" = "success" ] && \
             [ "${{ needs.security.result }}" = "success" ]; then
            echo "âœ… Todos os checks passaram!"
          else
            echo "âŒ Alguns checks falharam"
          fi
